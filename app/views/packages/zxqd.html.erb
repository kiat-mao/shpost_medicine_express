<!DOCTYPE HTML>
<html>
  <head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<%= stylesheet_link_tag "application", :media => "all" %>
		      <%= javascript_include_tag "application" %>

		<object id="LODOP_OB" classid="clsid:2105C259-1E0C-4534-8141-A753534CB4CA" width=0 height=0> 
		    <embed id="LODOP_EM" type="application/x-print-lodop" width=0 height=0 pluginspage="install_lodop.exe"></embed>
		</object>

	  <script language="javascript" type="text/javascript">
	  function zxqd_preview(){
	    LODOP=getLodop(document.getElementById('LODOP_OB'),document.getElementById('LODOP_EM'));  
	    if(LODOP == undefined){
	        window.open("CLodop_Setup_for_Win64NT.exe");
	    }
	    if(!LODOP.hasOwnProperty('PRINT') && (LODOP.VERSION == undefined)){
	        window.open("install_lodop32.exe");
	    }
	    LODOP.SET_LICENSES("上海市邮政公司信息技术局","452677782688188907989821905623","","");
	    <% @result.sort_by{|x| x.package_no.upcase}.each do |package| %>
	    LODOP.SET_PRINT_PAGESIZE(1,"210mm","297mm","");
	    LODOP.PRINT_INIT("打印装箱清单");
	    LODOP.ADD_PRINT_BARCODE("10mm","20mm","50mm","10mm","128A","<%= package.express_no %>");
	    // LODOP.SET_PRINT_STYLE("FontSize",10);
	    // LODOP.SET_PRINT_STYLE("Bold",1);
	    // LODOP.SET_PRINT_STYLE("ItemType",1);
	    // LODOP.ADD_PRINT_TEXT("19mm","20mm","50mm","10mm","邮件号");
	    LODOP.SET_PRINT_STYLE("FontSize",14);
	    LODOP.SET_PRINT_STYLE("Bold",1);  
	    LODOP.ADD_PRINT_TEXT("10mm","79mm","60mm","15mm","上药控股 服务为荣");
	    LODOP.ADD_PRINT_TEXT("17.3mm","80mm","60mm","10mm","延伸处方装箱清单");
	    LODOP.SET_PRINT_STYLE("FontSize",10);
	    LODOP.SET_PRINT_STYLE("Bold",1);  
	    LODOP.ADD_PRINT_TEXT("10mm","150mm","50mm","15mm","站点:<%= package.orders.first.site_no %>");
	    LODOP.ADD_PRINT_TEXT("16mm","155mm","50mm","15mm","<%= package.orders.first.site_id.to_s + package.orders.first.site_name %>");
	    LODOP.ADD_PRINT_TEXT("32mm","8mm","45mm","10mm","收货人:<%= package.orders.first.receiver_name %>");
	    LODOP.ADD_PRINT_TEXT("32mm","52mm","60mm","10mm","收货电话:<%= package.orders.first.receiver_phone %>");
	    LODOP.ADD_PRINT_TEXT("32mm","107mm","60mm","10mm","订单数:<%= package.orders.count %>");
	    LODOP.ADD_PRINT_TEXT("32mm","157mm","60mm","10mm","合计袋数:<%= package.get_all_bags %>");
	    LODOP.ADD_PRINT_TEXT("40mm","8mm","200mm","10mm","收货地址:<%= package.orders.first.receiver_addr %>");
	    <%  orders = package.orders.to_a
	    	until orders.blank? do %>
	    h = 175;
	    <% order5 = orders.pop(5) %>
	    <% order5.each do |o| %>
	  	LODOP.ADD_PRINT_LINE(h,"8mm",h,"200mm",0,2);
	  	LODOP.SET_PRINT_STYLE("FontSize",10);
	    LODOP.SET_PRINT_STYLE("Bold",1);  
	    LODOP.ADD_PRINT_TEXT(h+10,"8mm","50mm","10mm","顾客姓名:<%= o.customer_name %>");
	    LODOP.ADD_PRINT_TEXT(h+10,"50mm","50mm","10mm","联系电话:<%= o.customer_phone %>");
	    LODOP.ADD_PRINT_TEXT(h+10,"100mm","50mm","10mm","订单袋数:<%= o.bags.count %>");
	    LODOP.ADD_PRINT_TEXT(h+10,"150mm","50mm","10mm","开方日期:<%= o.prescription_date.strftime('%Y-%m-%d') %>");
	    LODOP.ADD_PRINT_TEXT(h+35,"8mm","200mm","10mm","顾客地址:<%= o.customer_addr %>");
	    LODOP.ADD_PRINT_TEXT(h+60,"8mm","80mm","10mm","订单号:<%= o.order_no %>");
	    LODOP.ADD_PRINT_TEXT(h+60,"80mm","100mm","10mm","处方单号:<%= o.prescription_no %>");
	    LODOP.ADD_PRINT_LINE(h+80,"8mm",h+80,"200mm",0,2);
	    LODOP.SET_PRINT_STYLE("FontSize",10);
	    LODOP.SET_PRINT_STYLE("Bold",0);  
	    LODOP.ADD_PRINT_TEXT(h+85,"8mm","200mm","10mm","商品编码          药品名称                  规格                      批号              数量");
	    LODOP.ADD_PRINT_LINE(h+100,"8mm",h+100,"200mm",0,1);
	    LODOP.ADD_PRINT_TEXT(h+135,"8mm","200mm","10mm","生产厂家:");
	    LODOP.ADD_PRINT_TEXT(h+160,"8mm","200mm","10mm","生产日期:                                    有效期:");
	    h += 175;

	  	<% end %>
	  	<% if !orders.blank? %>
	  	LODOP.NewPage();
	  	// LODOP.NEWPAGEA();
	  	<% end %>
	  	<% end %>
	  	LODOP.SET_PRINT_STYLE("ItemType",1);
	    LODOP.ADD_PRINT_TEXT("98%","160mm","80mm","30mm","打包日期：<%= Time.now.strftime('%Y-%m-%d') %>");
			LODOP.SET_PRINT_STYLE("ItemType",2);
	    LODOP.SET_PRINT_STYLE("Horient",2);
	    LODOP.SET_PRINT_STYLE("Vorient",1);
	    LODOP.ADD_PRINT_TEXT("98%","80%",100,39,"第#页/共&页");

	  	//设置某个打印机
	  	LODOP.SET_PRINTER_INDEXA("<%= current_user.normal_printer.blank? ? I18n.t('printer.normal_printer') : current_user.normal_printer %>");
	    // LODOP.PRINT_DESIGN();
			// LODOP.PREVIEW();
			LODOP.PRINT();
		<% end %>
		};

	  if (needCLodop()) {
		//如果是只运行C-Lodop,只需下边的代码，
		//C-Lodop----begin----
		window.On_CLodop_Opened=function(){
			zxqd_preview();	//OpenPreview()是调用打印方法						
			window.On_CLodop_Opened=null;
		};	
		//C-Lodop----end----				
	  } else 
	  window.onload = function(){
	  	zxqd_preview(); //使用lodop控件时的调用
	  	window.open('','_top');
      window.top.close();
	  };	
							
		
		</script>
	</head>
  
  <!-- <body onLoad="zxqd_preview();window.opener=null;window.open('','_top');window.top.close(); "> -->

  </body>
</html>